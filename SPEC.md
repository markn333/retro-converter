# Retro VDP Converter 仕様書

## 概要

レトロゲーム機のVDP（Video Display Processor）/PPU（Picture Processing Unit）の仕様に基づき、任意の画像を各機種の画面表示仕様に変換するWebアプリケーション。

## システム要件

### 動作環境
- モダンブラウザ（Chrome, Firefox, Safari, Edge）
- HTML5 Canvas API対応
- JavaScript ES6+対応

### 対応プラットフォーム
- PC（Windows, macOS, Linux）
- Android（Chrome, Firefox）
- iOS（Safari, Chrome）

## 技術仕様

### ファイル構成

```
retro-converter/
├── index.html      # メインアプリケーション（PWA対応）
├── manifest.json   # PWAマニフェスト
├── sw.js           # Service Worker（オフライン対応）
├── test.html       # ブラウザテストページ
├── icons/          # PWAアイコン
│   ├── icon-72.png
│   ├── icon-96.png
│   ├── icon-128.png
│   ├── icon-144.png
│   ├── icon-152.png
│   ├── icon-192.png
│   ├── icon-384.png
│   └── icon-512.png
├── SPEC.md         # 仕様書（本ファイル）
├── MANUAL.md       # ユーザーマニュアル
└── PROMPTS.md      # 作成時のプロンプト記録
```

### 入力形式

| 形式 | MIME Type |
|------|-----------|
| PNG | image/png |
| JPEG | image/jpeg |
| GIF | image/gif |
| WebP | image/webp |

### 出力形式

- PNG形式（image/png）
- ファイル名: `{機種名}_converted.png`

## 対応ゲーム機仕様

### Nintendo

#### スーパーファミコン (SNES/SFC)
| 項目 | 仕様 |
|------|------|
| チップ | S-PPU (5C77/5C78) |
| 解像度 | 256×224, 256×239, 512×224, 512×448 |
| 色深度 | 15bit (RGB555) |
| 総色数 | 32,768色 |
| 同時発色 | 最大256色 |
| タイルサイズ | 8×8 |
| BG面 | 最大4面 |
| スプライト | 最大128個 |

#### ファミコン (NES/FC)
| 項目 | 仕様 |
|------|------|
| チップ | 2C02 PPU |
| 解像度 | 256×240 (NTSC), 256×224 (表示領域) |
| 色深度 | 6bit (64色固定パレット) |
| 同時発色 | 最大25色 (BG13+SPR12) |
| タイルサイズ | 8×8 |
| BG面 | 1面 |
| スプライト | 最大64個 |

#### ゲームボーイ (GB)
| 項目 | 仕様 |
|------|------|
| チップ | DMG PPU |
| 解像度 | 160×144 |
| 色深度 | 2bit |
| 色数 | 4色（グレースケール） |
| タイルサイズ | 8×8 |
| スプライト | 最大40個 |

#### ゲームボーイカラー (GBC)
| 項目 | 仕様 |
|------|------|
| チップ | CGB PPU |
| 解像度 | 160×144 |
| 色深度 | 15bit (RGB555) |
| 総色数 | 32,768色 |
| 同時発色 | 最大56色 |
| タイルサイズ | 8×8 |
| スプライト | 最大40個 |

#### ゲームボーイアドバンス (GBA)
| 項目 | 仕様 |
|------|------|
| チップ | GBA PPU |
| 解像度 | 240×160 |
| 色深度 | 15bit (RGB555) |
| 総色数 | 32,768色 |
| 同時発色 | 最大256色 |
| タイルサイズ | 8×8 |
| スプライト | 最大128個 |

### SEGA

#### メガドライブ (Genesis)
| 項目 | 仕様 |
|------|------|
| チップ | VDP (YM7101) |
| 解像度 | 320×224 (H40), 256×224 (H32), 320×240 (PAL) |
| 色深度 | 9bit (RGB333) |
| 総色数 | 512色 |
| 同時発色 | 最大64色 |
| パレット | 4パレット×16色 |
| タイルサイズ | 8×8 |
| BG面 | 2面 (A/B) |
| スプライト | 最大80個 |

#### マスターシステム (SMS)
| 項目 | 仕様 |
|------|------|
| チップ | VDP (315-5124) |
| 解像度 | 256×192, 256×224 |
| 色深度 | 6bit (RGB222) |
| 総色数 | 64色 |
| 同時発色 | 最大32色 |
| タイルサイズ | 8×8 |
| スプライト | 最大64個 |

#### ゲームギア (GG)
| 項目 | 仕様 |
|------|------|
| チップ | VDP (315-5378) |
| 解像度 | 160×144 |
| 色深度 | 12bit (RGB444) |
| 総色数 | 4,096色 |
| 同時発色 | 最大32色 |
| タイルサイズ | 8×8 |
| スプライト | 最大64個 |

### NEC

#### PCエンジン (TurboGrafx-16)
| 項目 | 仕様 |
|------|------|
| チップ | HuC6270 VDC |
| 解像度 | 256×224, 336×224, 512×224 |
| 色深度 | 9bit (RGB333) |
| 総色数 | 512色 |
| 同時発色 | 最大256色 |
| パレット | 16パレット×16色 |
| タイルサイズ | 8×8 |
| スプライト | 最大64個 |

### MSX

#### MSX1
| 項目 | 仕様 |
|------|------|
| チップ | TMS9918 |
| 解像度 | 256×192 |
| 色深度 | 4bit |
| 色数 | 16色（固定パレット） |
| タイルサイズ | 8×8 |
| スプライト | 最大32個 |

#### MSX2
| 項目 | 仕様 |
|------|------|
| チップ | V9938 |
| 解像度 | 256×212, 512×212 |
| 色深度 | 9bit (RGB333) |
| 総色数 | 512色 |
| 同時発色 | 最大256色 |
| タイルサイズ | 8×8 |
| スプライト | 最大32個 |

### SNK

#### ネオジオ (Neo Geo)
| 項目 | 仕様 |
|------|------|
| チップ | LSPC2-A2 |
| 解像度 | 320×224 |
| 色深度 | 16bit |
| 総色数 | 65,536色 |
| 同時発色 | 最大4,096色 |
| パレット | 256パレット×16色 |
| タイルサイズ | 16×16 |
| スプライト | 最大380個 |

## 画像処理アルゴリズム

### 色深度変換

各機種の色深度に応じてRGB値を量子化：

```
変換後の値 = round(元の値 / 255 × maxVal) × 255 / maxVal
maxVal = 2^bitsPerChannel - 1
```

| 色深度 | bits/channel | maxVal |
|--------|--------------|--------|
| 15bit (RGB555) | 5 | 31 |
| 12bit (RGB444) | 4 | 15 |
| 9bit (RGB333) | 3 | 7 |
| 6bit (RGB222) | 2 | 3 |

### 減色アルゴリズム

**Median Cut法**を採用：

1. 全ピクセルの色を収集
2. RGB色空間で最大レンジを持つ軸を特定
3. 中央値で色空間を分割
4. 目標色数に達するまで繰り返し
5. 各バケットの重み付き平均を最終パレットとする

### ディザリング

#### Floyd-Steinberg法
誤差拡散ディザリング。量子化誤差を周囲のピクセルに分配：

```
右:        7/16
左下:      3/16
下:        5/16
右下:      1/16
```

#### Ordered (Bayer)法
4×4 Bayerマトリクスを使用した規則的ディザリング：

```
 0  8  2 10
12  4 14  6
 3 11  1  9
15  7 13  5
```

## API仕様

### グローバル変数

| 変数名 | 型 | 説明 |
|--------|------|------|
| CONSOLES | Object | ゲーム機仕様データベース |
| currentImage | Image | 現在読み込まれている画像 |
| convertedImageData | ImageData | 変換後の画像データ |

### 主要関数

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| loadImage | File | void | 画像ファイルを読み込み |
| convertImage | - | void | 画像を変換して表示 |
| convertColorDepth | ImageData, depth | ImageData | 色深度を変換 |
| reduceColors | ImageData, maxColors, method | {imageData, palette} | 減色処理 |
| applyFloydSteinberg | data, width, height, palette | void | Floyd-Steinbergディザリング |
| applyOrderedDither | data, width, height, palette | void | Orderedディザリング |
| downloadImage | - | void | 変換画像をダウンロード |

## 多言語対応（i18n）

### 対応言語

| 言語コード | 言語名 |
|------------|--------|
| ja | 日本語 |
| en | English |
| zh | 中文 |
| ko | 한국어 |

### 言語切り替え機能

- ヘッダー右上のドロップダウンで言語を選択
- 選択した言語はlocalStorageに保存され、次回起動時に復元
- 初回アクセス時はブラウザの言語設定を自動検出

### 翻訳データ構造

```javascript
const TRANSLATIONS = {
    ja: { ... },
    en: { ... },
    zh: { ... },
    ko: { ... }
};
```

### 翻訳対象

| カテゴリ | 内容 |
|----------|------|
| UI要素 | ボタン、ラベル、プレースホルダー |
| ゲーム機名 | 各機種の名称（ローカライズ版） |
| 設定項目 | 解像度、カラーモード、ディザリング |
| メッセージ | エラー、確認、説明文 |

## PWA仕様

### マニフェスト設定

| 項目 | 値 |
|------|-----|
| name | Retro VDP Converter |
| short_name | VDP Conv |
| display | standalone |
| theme_color | #e94560 |
| background_color | #1a1a2e |

### Service Worker

- キャッシュ戦略: Cache First（キャッシュ優先、なければネットワーク）
- キャッシュ名: `retro-vdp-converter-v2`
- キャッシュ対象: index.html, manifest.json, 全アイコンファイル

### 対応アイコンサイズ

72, 96, 128, 144, 152, 192, 384, 512px

## テスト仕様

### テストファイル

`test.html` - ブラウザベースのユニットテスト

### テストカテゴリ

| カテゴリ | テスト数 | 内容 |
|----------|----------|------|
| CONSOLES設定 | 6 | ゲーム機仕様データの検証 |
| 色深度変換 | 4 | RGB量子化の正確性 |
| パレット検索 | 5 | 最近傍色検索アルゴリズム |
| ディザリング | 2 | 減色処理の動作確認 |
| 解像度パース | 2 | 解像度文字列の解析 |
| Canvas API | 2 | ブラウザAPI動作確認 |

### テスト実行方法

1. `test.html` をブラウザで開く
2. 自動的にテストが実行される
3. 「テスト実行」ボタンで再実行可能

### テスト結果表示

- **Total**: テスト総数
- **OK**: 成功数
- **NG**: 失敗数
- 全テスト成功時: 緑の「ALL TESTS PASSED」
- 失敗あり: 赤の「SOME TESTS FAILED」

## 制限事項

1. **タイル単位の色制限なし**: 実機では8×8タイル単位で使用可能な色数に制限があるが、本アプリでは画面全体での色数制限のみ適用
2. **スプライト/BG分離なし**: スプライトとBGの色パレットは分離していない
3. **固定パレット機種**: NES、GB、MSX1は固定パレットを使用し、最適パレット選択は行わない

## バージョン履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0.0 | 2025-02-04 | 初版リリース |
| 1.1.0 | 2025-02-04 | PWA対応、テストページ追加 |
| 1.2.0 | 2025-02-04 | 多言語対応（日本語、英語、中国語、韓国語） |

## ライセンス

MIT License
